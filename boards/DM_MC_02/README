# DM-MC-02 Board Documentation

## Overview
The DM-MC-02 is a high-performance motor control board based on the STM32H723VGT6 microcontroller. This board is designed for advanced robotic applications requiring high-speed processing and multiple communication interfaces.

This project is generated by STM32CubeMX and integrated into the iRM Embedded framework.

## Hardware Specifications

### Microcontroller
- **MCU**: STM32H723VGT6
- **Core**: ARM Cortex-M7
- **Clock Speed**: Up to 550 MHz
- **Flash**: 1 MB
- **RAM**: 564 KB (including 192 KB TCM RAM)
- **FPU**: Double-precision FPU (FPv5-D16)

### Key Peripherals

#### Communication Interfaces
- **3× FDCAN** (FD CAN with flexible data rate)
  - FDCAN1: PD0 (RX), PD1 (TX)
  - FDCAN2: PB5 (RX), PB6 (TX)
  - FDCAN3: PD12 (RX), PD13 (TX)
  
- **USART** interfaces for serial communication
  - Remote control input on PD2

- **USB Device** (Full-speed)
  - USB CDC (Virtual COM Port) support

#### Storage & Memory
- **OctoSPI** interface for external memory
  - High-speed quad/octal SPI flash/RAM support
  - Supports memory-mapped mode

#### Sensors & Display
- **SPI** interfaces for:
  - IMU sensors (Accelerometer & Gyroscope with dedicated CS pins)
  - LCD display (1.14" color LCD)
    - CS: PE15
    - DC: PD10
    - RES: PB11
    - BLK: PB10

#### Timers & PWM
- Advanced timers for motor control
- General-purpose timers for PWM generation

#### Power Management
- **Power Control Pins**:
  - 24V Power 1: PC14
  - 24V Power 2: PC13
  - 5V Power: PC15

#### Other Features
- **ADC** for analog sensing
- **DMA** for efficient data transfer
- **DCMI** camera interface support (DCMI_PWDN: PC5, DCMI_REST: PB12)

## Software Configuration

### Build System
This board uses CMake as its build system and integrates with the iRM embedded framework.

#### Key Defines
- `STM32H723xx` - MCU family define
- `ARM_MATH_CM7` - ARM DSP library for Cortex-M7
- `BOARD_DM_MC_02` - Board identification
- `BOARD_HAS_FDCAN` - Enables FDCAN support instead of CAN
- `BOARD_HAS_OCTOSPI` - Enables OctoSPI peripheral support
- `USE_HAL_DRIVER` - Enables STM32 HAL library

### Peripheral Differences from Other Boards

#### FDCAN vs CAN
The DM-MC-02 uses FDCAN (Flexible Data-rate CAN) instead of traditional CAN:
- **Advantages**:
  - Higher data rates (up to 8 Mbps in data phase)
  - Larger payload (up to 64 bytes vs 8 bytes)
  - Better error handling
  - Backward compatible with classic CAN

- **BSP Abstraction**: 
  - Use `bsp::FDCAN` class (similar API to `bsp::CAN`)
  - Compatible with `bsp::CanBridge` for board-to-board communication
  - Classic CAN mode is used for compatibility with existing motors and devices

#### ARM DSP Library Support
The DM-MC-02 now includes **full ARM CMSIS DSP library support**, enabling:
- Fast Fourier Transform (FFT) operations
- Matrix operations
- Filtering functions (FIR, IIR, LMS, etc.)
- Statistics and support functions
- PID controllers and other control algorithms

The DSP library is compiled with optimizations for Cortex-M7 and double-precision FPU.

#### Excluded Features
The following BSP modules are **not supported** on DM-MC-02:
- `bsp_imu` - Use external IMU via SPI instead
- `bsp_laser` - No dedicated laser control
- `bsp_memory` - Use OctoSPI for external memory
- `bsp_os` - (check implementation details)
- `bsp_sdio` - No SD card interface
- `bsp_ultrasonic` - No dedicated ultrasonic support
- `bsp_usb` - USB CDC is configured but may need custom implementation
- `bsp_uart` - UART HAL differences require custom implementation

The following library modules are **not included** by default:
- `chassis` - Implement custom chassis control
- `fortress` - Not applicable for this board
- `gimbal` - Implement custom gimbal control
- `lidar07` - No default LiDAR support
- `pose` - Implement custom pose estimation
- `minipc_protocol` - Implement if needed
- `oled` - LCD is available instead
- `dbus`/`sbus` - Require UART implementation

#### Supported Library Modules
With ARM DSP support, the following modules **are now available**:
- ✅ `motor` - Full motor control (M2006, M3508, M3510, M6020, M6623, M4310)
- ✅ `controller` - PID and other control algorithms
- ✅ `encoder` - BRT encoder support
- ✅ `filtering` - Digital filtering algorithms
- ✅ `shooter` - Shooter control
- ✅ `steering` - Steering mechanism control
- ✅ `stepper` - Stepper motor control
- ✅ `supercap` - Supercapacitor management
- ✅ `unitree_motor` - Unitree motor support
- ✅ `user_interface` - User interface utilities
- ✅ `power_limit` - Power limiting algorithms

### FreeRTOS Support
The board includes FreeRTOS for real-time multitasking:
- FreeRTOS configuration in `Core/Inc/FreeRTOSConfig.h`
- CMSIS-RTOS v2 API available
- Optimized for Cortex-M7

## Development Setup

### Prerequisites
- ARM GCC toolchain (`arm-none-eabi-gcc`)
- CMake (version 3.8 or higher)
- OpenOCD or ST-Link utilities for flashing

### Building Examples
To build an example for DM-MC-02:

```bash
cd build
cmake ..
make example_<name>_DM_MC_02.elf
```

### Flashing
Using ST-Link:
```bash
make flash-example_<name>_DM_MC_02
```

Using OpenOCD:
```bash
make rflash-example_<name>_DM_MC_02
```

### Debugging
```bash
make debug-example_<name>_DM_MC_02
```

## Pin Mapping Reference

### Power
| Pin   | Function      |
|-------|---------------|
| PC13  | 24V Power 2   |
| PC14  | 24V Power 1   |
| PC15  | 5V Power      |

### FDCAN
| Pin   | Function      |
|-------|---------------|
| PD0   | FDCAN1_RX     |
| PD1   | FDCAN1_TX     |
| PB5   | FDCAN2_RX     |
| PB6   | FDCAN2_TX     |
| PD12  | FDCAN3_RX     |
| PD13  | FDCAN3_TX     |

### IMU Sensors
| Pin   | Function      |
|-------|---------------|
| PC0   | CS1_ACCEL     |
| PC3   | CS1_GYRO      |
| PE10  | INT1_ACCEL    |
| PE12  | INT1_GYRO     |

### LCD Display
| Pin   | Function      |
|-------|---------------|
| PE15  | LCD_CS        |
| PD10  | LCD_DC        |
| PB11  | LCD_RES       |
| PB10  | LCD_BLK       |

### Other
| Pin   | Function      |
|-------|---------------|
| PD2   | Remote (USART)|
| PC5   | DCMI_PWDN     |
| PB12  | DCMI_REST     |

## Example Usage

### FDCAN Example
```cpp
#include "bsp_fdcan.h"
#include "main.h"

extern FDCAN_HandleTypeDef hfdcan1;

void callback(const uint8_t data[], void* args) {
    // Handle received data
}

void setup() {
    // Initialize FDCAN with filter ID 0
    bsp::FDCAN can1(&hfdcan1, 0);
    
    // Register callback for CAN ID 0x200
    can1.RegisterRxCallback(0x200, callback);
    
    // Transmit data
    uint8_t data[8] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08};
    can1.Transmit(0x201, data, 8);
}
```

## Notes

1. **FDCAN Classic Mode**: By default, FDCAN is configured in classic CAN mode for compatibility with existing DJI motors and devices.

2. **OctoSPI**: External memory interface is available but requires proper initialization code.

3. **USB CDC**: Virtual COM port is configured but may require additional setup depending on your application.

4. **Power Sequencing**: Ensure proper power-up sequence for 24V and 5V rails.

5. **Clock Configuration**: The MCU runs at 550 MHz (maximum). Peripheral clocks are configured in `system_stm32h7xx.c`.

## Troubleshooting

### FDCAN Not Working
- Verify CAN transceiver connections
- Check termination resistors (120Ω)
- Ensure correct bit rate configuration (default: 1 Mbps)
- Verify filter configuration

### Build Errors
- Ensure all board-specific defines are set correctly
- Check that unsupported BSP modules are excluded
- Verify ARM toolchain installation

### Flashing Issues
- Check ST-Link connection
- Verify BOOT0 pin is low
- Try erasing flash: `st-flash erase`

## Additional Resources
- [STM32H723 Reference Manual](https://www.st.com/resource/en/reference_manual/rm0468-stm32h723733-stm32h725735-and-stm32h730-value-line-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [STM32H723 Datasheet](https://www.st.com/resource/en/datasheet/stm32h723vg.pdf)
- [FDCAN Documentation](https://www.st.com/resource/en/application_note/an5348-fdcan-peripheral-on-stm32-devices-stmicroelectronics.pdf)
- [DM-MC-02 Repository](https://github.com/RoboMaster-Club/control-base)

## License
Copyright (C) 2024 Illini RoboMaster @ University of Illinois at Urbana-Champaign

This project is licensed under the GNU General Public License v3.0.
