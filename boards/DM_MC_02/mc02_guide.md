# DM_MC_02 Board Configuration Guide

## Critical Configuration Points

### 1. STM32H7 DMA Memory Limitation ⚠️

**Issue**: STM32H7 DMA1/DMA2 cannot access DTCM RAM (0x20000000)

**Impact**: If heap is located in DTCM, DMA buffers allocated with `new` will cause DMA transfer failures

**Solution**: Use custom linker script to place heap in AXI SRAM (0x24000000)

### 2. Linker Script Configuration

This project uses a **dual linker script** architecture:

| File | Purpose | Overwritten by CubeMX? |
|------|---------|------------------------|
| `stm32h723vgtx_flash.ld` | CubeMX generated | ✅ Yes |
| `cmake/stm32h723vgtx_flash_custom.ld` | Actually used | ❌ No |

**CMake uses** `cmake/stm32h723vgtx_flash_custom.ld` with configuration:
- Heap: 16KB in AXI SRAM (DMA accessible)
- Stack: 4KB in AXI SRAM
- .bss: In AXI SRAM

### 3. Post-CubeMX Regeneration Steps

After regenerating code with CubeMX, run:

```bash
cd boards/DM_MC_02
./fix_linker_script.sh
```

The script automatically:
1. Copies from CubeMX-generated `stm32h723vgtx_flash.ld`
2. Modifies memory configuration for DMA compatibility
3. Updates `cmake/stm32h723vgtx_flash_custom.ld`

### 4. USB Configuration Notes

#### HSI48 Clock (Configured)
- Clock Configuration → HSI48: **Enable**
- USB Clock Source: **HSI48**

#### USB LPM Low Power Mode
- **Recommended**: Disable
- **Location**: USB_OTG_HS → Parameter Settings → Low Power Mode

If LPM must be enabled, a custom solution is provided:
- `USB_DEVICE/User/user_usbd_desc.c` includes BOS descriptor
- `CMakeLists.txt` configured to use custom version

### 5. FreeRTOS Configuration (Configured)

- API: **CMSIS_V2**
- `osKernelInitialize()` auto-generated by CubeMX in `main.c`

### 6. UART DMA Configuration Example

UART7 DMA RX configuration:
- DMA Request: UART7_RX
- Mode: Normal
- Direction: Peripheral to Memory

**Important**: DMA buffers are allocated on heap via `new`, so heap must be in DMA-accessible memory.

### 7. Board-Specific Features

- **FDCAN**: Uses `bsp_fdcan.cc` (other boards use `bsp_can.cc`)
- **USB**: Uses stub implementation `bsp_usb_stub.cc` (VirtualUSB not yet supported)
- **print()**: Available but USB output is stub implementation

## Quick Checklist

After CubeMX regeneration:
- [ ] Run `./fix_linker_script.sh`
- [ ] Verify HSI48 is enabled
- [ ] Verify USB LPM is disabled (if applicable)
- [ ] Rebuild and test

## Known Issues

1. `bsp_print.cc` depends on USB, currently using stub implementation
2. Some BSP modules not ported: IMU, Laser, SDIO, Ultrasonic

## Troubleshooting

For DMA-related issues, check:
1. Linker script using custom version
2. DMA buffers in correct memory region
3. Use `arm-none-eabi-nm` to verify symbol addresses

Example:
```bash
arm-none-eabi-nm build/examples/uart/example_uart_mc02.elf | grep heap
```

Address should be in `0x24000000` range.
